Ты работаешь как SENIOR FULLSTACK ENGINEER (Frontend + Backend) + SENIOR BACKEND SECURITY ENGINEER.
Проект УЖЕ СУЩЕСТВУЕТ в репле, это НЕ задание “создай новое приложение”.
Запрещено: создавать новый проект, заменять архитектуру на своё видение, переписывать всё на Replit Auth/новые таблицы “с нуля”, удалять текущий функционал, менять бизнес-логику, делать обфускацию JS.
Разрешено: точечно править существующий код, добавлять недостающие экраны/эндпоинты/валидации, исправлять UI, безопасность и баги.

0) РЕЖИМ РАБОТЫ (обязательный порядок)

Сначала инвентаризация: опиши, что уже есть в проекте (страницы, API, роли, навигация, отчёты, расходы, фото, карта, координаты).

Затем план фиксов: разбей на этапы, чтобы не ломать прод.

Затем исправляй по этапам: после каждого этапа кратко: что изменил + как проверить руками.

Никаких “я настроил новое приложение” — ты должен опираться на текущие файлы и текущую структуру проекта.

1) ИНВЕНТАРИЗАЦИЯ (СНАЧАЛА СДЕЛАЙ ЭТО)

Сначала найди и перечисли:

1.1 Страницы/роуты

какие страницы есть для ролей OWNER/MANAGER/FLORIST/COURIER

где домашняя страница, список заказов, деталка заказа, создание/редактирование заказа

где отчёты (общие и финансовые)

где расходы

где пользователи/помощники

где карта курьера/доставка

где dev-panel и что там есть (сессии/закрытие сессий/логин-как-пользователь и т.д.)

1.2 API endpoints

список ключевых /api/* эндпоинтов: auth/me, orders, expenses, attachments/photos, users, assistants/helpers, courier locations, reports, dev endpoints

какие роли имеют доступ к чему (и где это проверяется)

1.3 Хранение состояния и навигация

как устроена навигация (tabs/sidebar/layout)

где хранится состояние фильтров/вкладок/активной страницы

почему при refresh “теряются кнопки навигации”

1.4 Фото

как загружается фото (multipart? base64? url?)

где хранится (файлы на сервере? путь? db?)

как отдаётся другим пользователям

почему на разных аккаунтах фото не видно

почему на iPhone проблемы (HEIC/Content-Type/preview/upload)

1.5 Координаты курьера

как сейчас реализована отправка координат

с какой частотой

где сохраняется latest и история

где менеджер/владелец их видит

После инвентаризации — переходи к фиксам ниже.

2) ФИКСЫ ПО МОЕМУ СПИСКУ (В ТАКОМ ПРИОРИТЕТЕ)

Делай по этапам: A → B → C → D.
После каждого этапа — чеклист проверки.

ЭТАП A — КНОПКИ / КЛИКАБЕЛЬНОСТЬ / НАВИГАЦИЯ / ПОИСК (чтобы перестало бесить)
A1) Кнопка “карты” → открытие Яндекс Карт

По клику по адресу/кнопке должен открываться Яндекс:

если есть координаты → открывать маршрут/точку

если координат нет → открывать по тексту адреса

На web открывать в новой вкладке, на мобиле через Linking/URL

A2) Поиск

Добавить поиск по номеру заказа

Поиск должен запускаться ТОЛЬКО ПО НАЖАТИЮ КНОПКИ “Поиск”

Поиск не должен вылетать/крашиться через несколько секунд

Добавить поисковую строку всем сотрудникам (OWNER/MANAGER/FLORIST/COURIER)

Сделать корректную обработку конкурентных запросов (не показывать старые результаты)

A3) “Просрочено”

Кнопка/фильтр “Просрочено” должна быть всегда вверху и кликабельна

Фильтры должны быть sticky/фиксированы, чтобы не уезжали

На мобиле не ломать верстку

A4) “Доставленные” вниз

В списках заказов доставленные уходят вниз

Текущие и новые сверху

Приоритетные (см. этап B) должны быть выше всех

A5) Навигация теряется при обновлении

При refresh/перезагрузке страницы кнопки навигации и активный раздел не исчезают

Состояние (активная вкладка, фильтры) должно восстанавливаться корректно

A6) Верстка на всех устройствах

Исправить “плывёт”, “белые прямоугольники”, элементы вылезают за границы

Нормальный container/высоты/scroll на iOS и на web

Проверить: iPhone Safari, Android Chrome, desktop Chrome

Нельзя чтобы куски экрана не отрисовывались до конца телефона

Проверка этапа A (обязательно описать):

поиск работает только по кнопке и не падает

“Просрочено” кликается и всегда сверху

доставленные внизу

навигация не пропадает после F5

Яндекс карты открываются корректно

мобильная верстка не ломается

ЭТАП B — РАСХОДЫ / ОТЧЁТЫ / СТАТИСТИКА (кликабельность + списки)
B1) “Добавить расход” не работает

Исправить кнопку и логику отправки

Расход ОБЯЗАТЕЛЬНО содержит комментарий “на что расход”

После добавления расход появляется в списке

У владельца/менеджера расходы видны отчётами

B2) Расходы кликабельны

Расходы должны открывать подробный список

В списке: сумма, комментарий, кто добавил, дата/время, к какому заказу

Из списка должен быть переход в заказ

B3) Отчёты кликабельны у всех

Все кнопки отчётов должны быть кликабельны

При нажатии → открывается список деталей (не просто цифра)

Любой отчёт → подробный список → из списка можно открыть заказ/пользователя

B4) Статистика у курьеров и флористов

Сейчас кнопки статистики не кликабельны — исправить

По клику открывать список заказов, который сформировал эту цифру

Статистика должна обновляться автоматически (например, при фокусе экрана или с разумным интервалом)

Проверка этапа B:

добавить расход работает

расход открывается и показывает комментарии

отчёты и статистики кликаются и открывают списки

ЭТАП C — КУРЬЕРЫ / КАРТА / НОМЕРА ЗАКАЗОВ / ПОМОЩНИКИ
C1) Номера заказов видны всем работникам

У курьеров сейчас нет номера заказа — исправить (в списке и в деталке)

C2) Карта курьера

На карте при нажатии на заказ должна быть кнопка “Перейти в заказ”

По кнопке открывается детальная страница заказа

C3) Удаление помощников

Кнопки удаления помощников не работают — исправить

После удаления список обновляется

Проверка этапа C:

курьер видит номера заказов

карта → заказ → кнопка “перейти” работает

удаление помощников работает

ЭТАП D — ДОПОЛНЕНИЯ В ЗАКАЗЕ + ФОТО + КООРДИНАТЫ + SECURITY
D1) Приоритет/выражения в заказе

Добавить в заказ выбор “Срочно сейчас”, “В течение дня”, “Уточнить у получателя”

“Срочно сейчас” всегда наверху у всех исполнителей

“В течение дня” отображается как метка

“Уточнить у получателя”: возможность сохранить заказ и потом дозаполнить (в процессе)

В интерфейсе должен быть понятный статус/бейдж

D2) Фото не отображаются на разных аккаунтах

Исправить логику хранения/выдачи фото так, чтобы фото были доступны всем, у кого есть доступ к заказу

Нельзя, чтобы фото было “привязано” к одному аккаунту или к локальной ссылке

D3) Проблемы фото на iPhone

Исправить загрузку и просмотр на айфонах

Учесть HEIC/Content-Type/таймауты/preview

D4) Координаты курьера

Объяснить, как сейчас реализовано

Сделать оптимально: онлайн и непрерывно, но без перегрузки серверов

отправка по таймеру и/или по изменению расстояния

latest отдельно от истории

разумные интервалы (например 5–10 сек при активном заказе)

Не ломать текущую карту и отображение

D5) SECURITY HARDENING (строго по требованиям)

ЗАДАЧА: ЗАПРЕТИТЬ ДОСТУП К ЛЮБЫМ ИСХОДНИКАМ И СЕРВЕРНЫМ ФАЙЛАМ В ПРОДАКШЕНЕ FLORAORDERS.

НУЖНО:

STATIC FILES FIX

Найди где используется express.static

В продакшене разрешено отдавать ТОЛЬКО папку dist

Никаких process.cwd(), ".", "../" и т.п.

Сделать строго: static только dist, затем catch-all на index.html

ЗАПРЕТИТЬ ДОСТУП К ОПАСНЫМ РАСШИРЕНИЯМ

middleware ДО static:

блокировать:

.env

.ts .tsx

.map

.log

.md

.config

package.json

drizzle.config.ts

любые скрытые файлы (начинаются с .)

.json (кроме API)

если запрос содержит такие пути → 404

ОТКЛЮЧИТЬ SOURCE MAPS В ПРОДЕ

убедиться, что сборка не генерирует .map, или удалять их из dist

ЗАПРЕТИТЬ ОТДАЧУ ДИРЕКТОРИЙ

/server /shared /migrations /deploy /server_dist → всегда 404

EXPRESS SECURITY HARDENING

app.disable('x-powered-by')

helmet

strict CSP

no-cache для HTML

ПРОВЕРКА
После изменений проверить, что 404 на:

/server/index.ts

/.env

/shared/schema.ts

/deploy/install.sh

/package.json

/drizzle.config.ts

/dist/*.map

/server_dist/

И при этом /api/* работает и фронтенд открывается.

ВАЖНО:

НЕ добавлять обфускацию JS

НЕ ломать сборку

НЕ менять бизнес-логику

Проверка этапа D:

приоритеты работают и сортируют

фото видно у разных аккаунтов

iPhone фото работает

координаты не грузят сервер

unsafe paths дают 404, /api работает

3) ВЫВОДЫ ПОСЛЕ РАБОТЫ (в конце)

Когда закончишь этапы — выдай:

список всех исправленных пунктов (1–23)

как проверить каждую функцию (коротко)

что изменилось в безопасности и почему теперь нельзя скачать исходники через F12/Network

Важные ограничения

Не придумывай “другую” БД схему без необходимости. Если надо добавить поля/enum — делай минимально.

Любая кнопка/отчёт/статистика должна открывать подробный список по нажатию.

Поиск только по кнопке.

Dev panel и доступы не ломать, но усилить безопасность как указано.